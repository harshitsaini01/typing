<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TypingHub - SSC CGL Typing Test</title>
  <style>
    /* Reset default styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    /* Body: Times New Roman, full window */
    body {
      font-family: 'Times New Roman', Times, serif;
      background: #f5f5f5;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      margin: 0;
      width: 100vw;
      overflow-x: hidden;
    }

    /* Main content area */
    .main-content {
      flex: 1;
      background: #fff;
      display: flex;
      flex-direction: column;
      width: 100vw;
      padding: 0;
      margin: 0;
    }

    /* Navigation bar */
    nav {
      background: #fff;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 1000;
      width: 100vw;
      max-width: none;
      margin-bottom: 0;
    }

    .nav-brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .nav-brand img {
      width: 70px;
      height: auto;
    }

    .nav-brand a {
      font-family: 'Roboto Serif', serif;
      font-size: 22px;
      font-weight: 700;
      color: #1976d2;
      text-decoration: none;
    }

    .nav-brand a:hover {
      color: #40c4ff;
    }

    .nav-links {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .nav-links a {
      color: #333;
      text-decoration: none;
      font-size: 16px;
      padding: 8px 15px;
      border-radius: 4px;
      font-weight: 400;
      transition: background-color 0.3s, color 0.3s;
    }

    .nav-links a:hover {
      background-color: #FFFF00;
      color: #000;
    }

    .nav-links a.active {
      background-color: #1976d2;
      color: #fff;
    }

    /* Headings */
    h3 {
      font-family: 'Roboto Serif', serif;
      color: #1a2a44;
      font-size: 20px;
      font-weight: 700;
      text-transform: uppercase;
      text-align: center;
    }

    h4 {
      font-family: 'Roboto Serif', serif;
      color: #1a2a44;
      font-size: 22px;
      font-weight: 600;
      margin: 15px 0 10px;
    }

    p {
      color: #555;
      font-size: 16px;
      line-height: 1.5;
      margin-bottom: 5px;
    }

    /* Buttons */
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      margin-right: 10px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }

    .btn-primary {
      background: #1976d2;
      color: #fff;
    }

    .btn-primary:hover {
      background: #1565c0;
    }

    .btn-danger {
      background: #ef5350;
      color: #fff;
    }

    .btn-danger:hover {
      background: #d32f2f;
    }

    .btn-success {
      background: #4caf50;
      color: #fff;
    }

    .btn-success:hover {
      background: #388e3c;
    }

    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    /* Test container */
    .test-container {
      display: flex;
      flex-direction: row;
      flex-wrap: nowrap;
      width: 100vw;
      max-width: none;
      min-height: calc(100vh - 80px - 200px);
      padding: 0 10px;
      gap: 0;
      background: #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      margin-top: 0;
    }

    /* Main test section */
    .test-main {
      flex: 3;
      min-width: 300px;
      display: flex;
      flex-direction: column;
      padding-right: 10px;
      margin-right: 0;
    }

    /* Results section */
    .result-section {
      flex: 1;
      min-width: 250px;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      position: relative;
      padding-left: 10px;
      margin-left: 0;
      background: linear-gradient(135deg, #f8fafc, #e3f2fd);
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
      border-radius: 6px;
      border-left: 1px solid #ccc;
    }

    /* Test header */
    .test-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      margin-top: 0;
      background: #f9f9f9;
      padding: 10px;
      border-radius: 6px;
      width: 100%;
      font-size: 14px;
      gap: 15px;
      height: 48px; /* Fixed height for consistency */
    }

    .selector-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .selector-label {
      font-size: 14px;
      font-weight: 500;
      color: #1a2a44;
      font-family: 'Roboto Serif', serif;
      white-space: nowrap;
    }

    select {
      padding: 7px;
      font-size: 18px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      background: #fff;
      font-family: 'Times New Roman', Times, serif;
      width: 180px;
      transition: border-color 0.3s;
    }

    select:focus {
      border-color: #1976d2;
      outline: none;
    }

    /* Timer display */
    .timer {
      font-size: 14px;
      font-weight: 500;
      color: #fff;
      background: #ef5350;
      padding: 6px 10px;
      border-radius: 6px;
    }

    .timer.low-time {
      background: #d32f2f;
    }

    /* Passage container */
    .sample-text-container {
      height: 200px;
      overflow-y: auto;
      background: #fff;
      border: 2px solid #ccc;
      border-radius: 6px;
      padding: 10px;
      margin-bottom: 10px;
      width: 100%;
      cursor: default;
      line-height: 28px; /* Fixed line height for consistent scrolling */
    }

    .sample-text {
      font-size: 18px;
      line-height: 28px;
      white-space: pre-wrap;
      font-family: 'Times New Roman', Times, serif;
      user-select: none;
      word-spacing: normal;
    }

    .word {
      display: inline;
      margin: 0;
      padding: 0;
    }

    .current-word {
      padding: 0 1px;
      border-radius: 2px;
    }

    .correct-char {
      background: #4caf50;
      color: #fff;
      padding: 1px;
    }

    .incorrect-char {
      background: #ef5350;
      color: #fff;
      padding: 1px;
    }

    /* Typing area */
    textarea {
      width: 100%;
      height: 200px;
      resize: none;
      padding: 7px;
      font-size: 18px;
      border: 2px solid #ccc;
      border-radius: 6px;
      background: #fff;
      font-family: 'Times New Roman', Times, serif;
      margin-bottom: 10px;
      transition: border-color 0.3s;
      line-height: 28px;
      word-spacing: normal;
    }

    textarea:focus {
      border-color: #1976d2;
      outline: none;
    }

    /* Control buttons container */
    .control-buttons {
      display: flex;
      align-items: center;
      gap: 10px; /* Gap between Start, Pause, Restart, Submit */
    }

    /* Results styling */
    .result-section .result-header {
      background: #f9f9f9;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 10px;
    }

    .result-section .metric-block {
      padding: 8px 12px;
      border-radius: 6px;
      margin: 5px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
      font-family: 'Times New Roman', Times, serif;
      background: #fff;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      transition: transform 0.2s, background-color 0.3s;
      animation: fadeInMetric 0.5s ease;
    }

    .result-section .metric-block:hover {
      transform: translateY(-2px);
      background: #fafafa;
    }

    @keyframes fadeInMetric {
      from { opacity: 0; transform: translateY(5px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .result-section .metric-block span:first-child::before {
      content: '';
      display: inline-block;
      width: 16px;
      height: 16px;
      margin-right: 8px;
      vertical-align: middle;
    }

    .result-section .metric-block:nth-child(2) span:first-child::before {
      background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%231976d2"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm1-13h-2v6l5.25 3.15.75-1.23-4.5-2.67V7z"/></svg>') no-repeat center/16px;
    }

    .result-section .metric-block:nth-child(3) span:first-child::before {
      background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%231976d2"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8 8 3.59 8 8-3.59-8 8zm1-13h-2v6l5.25 3.15.75-1.23-4.5-2.67V7z"/></svg>') no-repeat center/16px;
    }

    .result-section .metric-block:nth-child(4) span:first-child::before {
      background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%234caf50"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>') no-repeat center/16px;
    }

    .result-section .metric-block:nth-child(5) span:first-child::before {
      background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23ef5350"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>') no-repeat center/16px;
    }

    .result-section .metric-block:nth-child(6) span:first-child::before {
      background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%231976d2"><path d="M4 4h16v16H4V4zm2 2v12h12V6H6z"/></svg>') no-repeat center/16px;
    }

    .result-section .metric-block:nth-child(7) span:first-child::before {
      background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%234caf50"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>') no-repeat center/16px;
    }

    .result-section .metric-block:nth-child(8) span:first-child::before {
      background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23ef5350"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>') no-repeat center/16px;
    }

    .result-section .metric-block span:last-child {
      font-size: 16px;
      font-weight: 600;
      color: #000;
      text-align: right;
      min-width: 80px;
      transition: color 0.3s;
    }

    /* Feedback container (modern orange box) */
    .feedback-container {
      position: relative;
      margin: 10px 12px;
      padding: 15px;
      background: #ff9800; /* Orange background */
      color: #fff;
      font-family: 'Times New Roman', Times, serif;
      font-size: 20px;
      line-height: 1.5;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2), 0 0 10px rgba(255,152,0,0.5);
      transform: skew(-5deg); /* Slight skew for modern look */
      display: none; /* Hidden by default */
    }

    .feedback-container.show {
      display: block;
    }

    /* Feedback text inside the container */
    .feedback-text {
      transform: skew(5deg); /* Counter-skew the text to make it readable */
    }

    /* Cancel button for feedback */
    .feedback-cancel {
      position: absolute;
      top: -10px;
      right: -10px;
      background: #d32f2f;
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      font-size: 14px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
      transition: background 0.3s;
    }

    .feedback-cancel:hover {
      background: #b71c1c;
    }

    /* Promotion section with improved organization */
    .promotion-section {
      padding: 40px 0;
      background: #f8f9fa;
      border-top: 2px solid #1976d2;
    }

    .promotion-hero {
      text-align: center;
      margin-bottom: 40px;
      padding: 0 20px;
    }

    .promotion-hero h2 {
      font-family: 'Roboto Serif', serif;
      font-size: 32px;
      color: #1a2a44;
      margin-bottom: 15px;
    }

    .promotion-hero p {
      font-size: 18px;
      color: #555;
    }

    .promotion-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 30px;
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }

    .promotion-card {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      overflow: hidden;
      transition: transform 0.3s;
    }

    .promotion-card:hover {
      transform: translateY(-5px);
    }

    .promotion-card.featured {
      border: 2px solid #1976d2;
      position: relative;
    }

    .card-header {
      background: linear-gradient(135deg, #1976d2, #1565c0);
      color: #fff;
      padding: 20px;
      text-align: center;
      position: relative;
    }

    .card-header i {
      font-size: 32px;
      margin-bottom: 10px;
    }

    .card-header h3 {
      font-family: 'Roboto Serif', serif;
      font-size: 22px;
      margin: 0;
    }

    .featured-tag {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #ffd700;
      color: #000;
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 12px;
      font-weight: bold;
    }

    .card-content {
      padding: 20px;
    }

    .feature-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .feature-list li {
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 10px;
      color: #555;
      font-size: 16px;
    }

    .feature-list li i {
      color: #1976d2;
    }

    .premium-btn {
      display: block;
      background: linear-gradient(135deg, #1976d2, #1565c0);
      color: #fff;
      text-align: center;
      padding: 12px;
      border-radius: 4px;
      text-decoration: none;
      margin-top: 20px;
      font-weight: bold;
      transition: transform 0.3s;
    }

    .premium-btn:hover {
      transform: scale(1.05);
    }

    .why-choose-section {
      max-width: 1200px;
      margin: 60px auto 0;
      padding: 0 20px;
      text-align: center;
    }

    .why-choose-section h3 {
      font-family: 'Roboto Serif', serif;
      font-size: 28px;
      color: #1a2a44;
      margin-bottom: 30px;
    }

    .benefits-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
    }

    .benefit-item {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .benefit-item i {
      font-size: 28px;
      color: #1976d2;
      margin-bottom: 15px;
    }

    .benefit-item h4 {
      font-family: 'Roboto Serif', serif;
      font-size: 18px;
      color: #1a2a44;
      margin-bottom: 10px;
    }

    .benefit-item p {
      color: #555;
      font-size: 14px;
      line-height: 1.4;
    }

    @media (max-width: 992px) {
      .promotion-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .benefits-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 768px) {
      .promotion-grid {
        grid-template-columns: 1fr;
      }

      .promotion-hero h2 {
        font-size: 24px;
      }

      .promotion-hero p {
        font-size: 16px;
      }

      .benefits-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Footer */
    footer {
      background: linear-gradient(135deg, #e3f2fd, #bbdefb);
      color: #333;
      padding: 45px;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 20px;
      box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
      border-top: 1px solid #1976d2;
      width: 100vw;
      max-width: none;
    }

    .footer-middle {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      flex: 2;
    }

    footer h3 {
      color: #1976d2;
      font-size: 18px;
      margin-bottom: 12px;
      text-transform: uppercase;
    }

    footer a {
      color: #333;
      text-decoration: none;
      font-size: 16px;
      display: block;
      margin-bottom: 10px;
    }

    footer a:hover {
      color: #1565c0;
    }

    footer p {
      color: #333;
      font-size: 16px;
      margin-bottom: 10px;
    }

    .footer-copyright {
      text-align: center;
      width: 100%;
      color: #333;
      font-size: 16px;
      margin-bottom: 10px;
    }

    .footer-section {
      flex: 1;
      min-width: 200px;
      padding-right: 20px;
      border-right: 1px solid rgba(0,0,0,0.1);
    }

    .footer-section:last-child {
      border-right: none;
    }

    .footer-section.logo-section {
      display: flex;
      align-items: center;
      gap: 10px;
      border-right: none;
    }

    .footer-section.logo-section img {
      width: 80px;
      height: auto;
    }

    .footer-section.social-contacts a {
      display: inline-block;
      margin-right: 12px;
      font-size: 22px;
      color: #333;
    }

    .footer-section.social-contacts a:hover {
      transform: scale(1.2);
      color: #1976d2;
    }

    .footer-section.social-contacts p.email {
      color: #1976d2;
    }

    /* Responsive design */
    @media (max-width: 768px) {
      .test-container {
        flex-direction: column;
        padding: 10px;
        width: 100vw;
        max-width: none;
      }

      .test-main {
        padding-right: 0;
      }

      .result-section {
        position: static;
        order: -1;
        margin-bottom: 10px;
        padding-left: 0;
        border-left: none;
      }

      .sample-text-container, textarea {
        height: 150px;
      }

      .nav-brand img {
        width: 35px;
      }

      .nav-brand a {
        font-size: 18px;
      }

      .nav-links {
        flex-direction: column;
        gap: 8px;
        width: 100%;
        align-items: stretch;
      }

      .nav-links a {
        padding: 8px;
        text-align: center;
      }

      .promotion-section {
        padding: 15px 0;
        width: 100vw;
      }

      .promotion-content {
        padding: 0 15px;
      }

      .promotion-section h3 {
        font-size: 24px;
      }

      .promotion-section h4 {
        font-size: 20px;
      }

      .promotion-section p {
        font-size: 18px;
      }

      .feedback-container {
        font-size: 18px;
        padding: 0 8px;
      }

      footer {
        flex-direction: column;
        text-align: center;
        padding: 30px;
        width: 100vw;
        max-width: none;
      }

      .footer-middle {
        flex-direction: column;
        gap: 20px;
      }

      .footer-section {
        padding-right: 0;
        border-right: none;
      }

      .footer-section.logo-section img {
        width: 40px;
      }

      /* Stack buttons vertically on mobile */
      .control-buttons {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }
    }

    @media (max-width: 600px) {
      nav {
        flex-direction: column;
        gap: 10px;
        padding: 10px;
      }

      .test-header {
        flex-direction: column;
        gap: 10px;
        height: auto;
      }

      .selector-group {
        flex-direction: column;
        align-items: flex-start;
        width: 100%;
      }

      select {
        width: 100%;
      }

      .result-section .metric-block {
        font-size: 12px;
      }

      .result-section .metric-block span:last-child {
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <!-- Header: Dynamically loaded -->
  <div id="header"></div>

  <main class="main-content">
    <div id="typing-test-page">
      <div class="test-container">
        <!-- Main test section -->
        <div class="test-main">
          <!-- Test header: Passage selector, timer duration, and timer -->
          <div class="test-header">
            <div class="selector-group">
              <label for="passage-selector" class="selector-label">Select Passage</label>
              <select id="passage-selector"></select>
            </div>
            <div class="selector-group">
              <label for="timer-duration" class="selector-label">Duration</label>
              <select id="timer-duration">
                <option value="120">2 min</option>
                <option value="300">5 min</option>
                <option value="600">10 min</option>
                <option value="900" selected>15 min</option>
              </select>
            </div>
            <div id="timer" class="timer">15:00</div>
          </div>

          <!-- Passage display -->
          <div id="sample-text-container" class="sample-text-container" tabindex="0">
            <p id="sample-text" class="sample-text"></p>
          </div>

          <!-- Typing area -->
          <textarea id="typing-area" placeholder="Start typing here..." disabled></textarea>

          <!-- Control buttons -->
          <div class="control-buttons">
            <button id="start-test" class="btn btn-primary">Start</button>
            <button id="stop-test" class="btn btn-danger" disabled>Pause</button>
            <button id="restart-test" class="btn btn-success" disabled>Restart</button>
            <button id="submit-test" class="btn btn-danger" disabled>Submit</button>
          </div>
        </div>

        <!-- Live results -->
        <div class="result-section">
          <div class="result-header">
            <h3>RESULT</h3>
          </div>
          <div class="metric-block">
            <span>Gross Speed:</span>
            <span><span id="live-gross-speed">0</span> wpm</span>
          </div>
          <div class="metric-block">
            <span>Net Speed:</span>
            <span><span id="live-net-speed">0</span> wpm</span>
          </div>
          <div class="metric-block">
            <span>Accuracy:</span>
            <span><span id="live-accuracy">0</span>%</span>
          </div>
          <div class="metric-block">
            <span>Mistakes:</span>
            <span id="live-mistakes">0</span>
          </div>
          <div class="metric-block">
            <span>Total Words:</span>
            <span id="live-total-words">0</span>
          </div>
          <div class="metric-block">
            <span>Correct Words:</span>
            <span id="live-correct-words">0</span>
          </div>
          <div class="metric-block">
            <span>Incorrect Words:</span>
            <span id="live-incorrect-words">0</span>
          </div>
          <!-- Feedback container (modern orange box with cancel button) -->
          <div id="feedback-container" class="feedback-container">
            <p id="feedback-text" class="feedback-text"></p>
            <button id="feedback-cancel" class="feedback-cancel">✕</button>
          </div>
        </div>
      </div>

      <!-- Promotion content with improved organization -->
      <div class="promotion-section">
        <div class="promotion-hero">
          <h2>Master Typing with TypingHub's Free & Premium Programs</h2>
          <p>Your gateway to typing excellence and exam success</p>
        </div>

        <div class="promotion-grid">
          <!-- Free Features Card -->
          <div class="promotion-card">
            <div class="card-header">
              <i class="fas fa-gift"></i>
              <h3>Free Typing Test Features</h3>
            </div>
            <div class="card-content">
              <ul class="feature-list">
                <li><i class="fas fa-check"></i> SSC CGL/CHSL Typing Test with real exam passages</li>
                <li><i class="fas fa-check"></i> Live Speed & Accuracy tracking</li>
                <li><i class="fas fa-check"></i> Multiple test durations (2, 5, 10, 15 minutes)</li>
                <li><i class="fas fa-check"></i> Detailed performance analysis</li>
                <li><i class="fas fa-check"></i> Screen and paper typing options</li>
              </ul>
            </div>
          </div>

          <!-- Premium Benefits Card -->
          <div class="promotion-card featured">
            <div class="card-header">
              <i class="fas fa-crown"></i>
              <h3>Premium Course Benefits</h3>
              <span class="featured-tag">Recommended</span>
            </div>
            <div class="card-content">
              <ul class="feature-list">
                <li><i class="fas fa-star"></i> Structured Learning Path</li>
                <li><i class="fas fa-star"></i> Home Row Mastery Training</li>
                <li><i class="fas fa-star"></i> Advanced Keyboard Practice</li>
                <li><i class="fas fa-star"></i> Word & Sentence Drills</li>
                <li><i class="fas fa-star"></i> Real Exam Simulations</li>
                <li><i class="fas fa-star"></i> Personal Progress Tracking</li>
                <li><i class="fas fa-star"></i> Expert Support & Guidance</li>
              </ul>
              <a href="/courses/typing" class="premium-btn">Join Premium Course</a>
            </div>
          </div>

          <!-- Success Tips Card -->
          <div class="promotion-card">
            <div class="card-header">
              <i class="fas fa-lightbulb"></i>
              <h3>Success Tips</h3>
            </div>
            <div class="card-content">
              <ul class="feature-list">
                <li><i class="fas fa-check"></i> Practice regularly - 30 minutes daily</li>
                <li><i class="fas fa-check"></i> Focus on accuracy before speed</li>
                <li><i class="fas fa-check"></i> Use proper finger placement</li>
                <li><i class="fas fa-check"></i> Take short breaks to maintain focus</li>
                <li><i class="fas fa-check"></i> Track progress and set daily goals</li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Why Choose TypingHub Section -->
        <div class="why-choose-section">
          <h3>Why Choose TypingHub?</h3>
          <div class="benefits-grid">
            <div class="benefit-item">
              <i class="fas fa-graduation-cap"></i>
              <h4>Exam-Focused</h4>
              <p>Specially designed for government exam preparation</p>
            </div>
            <div class="benefit-item">
              <i class="fas fa-chart-line"></i>
              <h4>Error Tracking</h4>
              <p>Real-time error tracking and feedback</p>
            </div>
            <div class="benefit-item">
              <i class="fas fa-mobile-alt"></i>
              <h4>Mobile Friendly</h4>
              <p>Practice on any device, anytime</p>
            </div>
            <div class="benefit-item">
              <i class="fas fa-sync"></i>
              <h4>Regular Updates</h4>
              <p>New practice material added regularly</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Footer: Dynamically loaded -->
  <div id="footer"></div>

  <script>
    // Define base URL for API calls
    const BASE_URL = window.location.origin.includes('localhost') 
        ? 'http://localhost:5000' 
        : window.location.origin;

    // Load header dynamically
    fetch('header.html')
      .then(response => {
        if (!response.ok) throw new Error('Header fetch failed: ' + response.status);
        return response.text();
      })
      .then(data => {
        console.log('Header loaded successfully');
        document.getElementById('header').innerHTML = data;
        initializeNavigation();
      })
      .catch(error => {
        console.error('Error loading header:', error);
      });

    // Load footer dynamically
    fetch('footer.html')
      .then(response => {
        if (!response.ok) throw new Error('Footer fetch failed: ' + response.status);
        return response.text();
      })
      .then(data => {
        console.log('Footer loaded successfully');
        document.getElementById('footer').innerHTML = data;
      })
      .catch(error => {
        console.error('Error loading footer:', error);
      });

    // Highlight active navigation link
    function initializeNavigation() {
      const navLinks = document.querySelectorAll('.nav-links a');
      navLinks.forEach(link => {
        if (link && link.getAttribute('href') === 'typing-test.html') {
          link.classList.add('active');
        } else if (link) {
          link.classList.remove('active');
        }
      });
    }

    // Align result section dynamically
    function alignResultSection() {
      const testHeader = document.querySelector('.test-header');
      const sampleTextContainer = document.querySelector('.sample-text-container');
      const typingArea = document.querySelector('textarea');
      const resultSection = document.querySelector('.result-section');

      const testHeaderHeight = testHeader.offsetHeight;
      const sampleTextHeight = sampleTextContainer.offsetHeight;
      const typingAreaHeight = typingArea.offsetHeight;
      const margins = 20; // 10px margin-bottom for test-header and sample-text-container

      const totalHeight = testHeaderHeight + sampleTextHeight + typingAreaHeight + margins;
      resultSection.style.height = `${totalHeight}px`;
    }

    // Typing test logic
    let passages = [];
    let passageWords = [];
    let timerInterval;
    let timeLeft = 900; // Default to 15 minutes per SSC CGL requirement
    let isRunning = false;
    let currentWordIndex = 0;
    let typedWords = [];
    let totalChars = 0;
    let correctChars = 0;
    let mistakes = 0;
    let correctWordsCount = 0;
    let incorrectWordsCount = 0;
    let startTime;
    let wordElements = []; // Cache word elements
    let wordsPerLine = 0; // Approximate words per line
    let currentLine = 0; // Track current line

    // DOM elements
    const passageSelector = document.getElementById('passage-selector');
    const timerDurationSelector = document.getElementById('timer-duration');
    const timerDisplay = document.getElementById('timer');
    const sampleTextContainer = document.getElementById('sample-text-container');
    const sampleText = document.getElementById('sample-text');
    const typingArea = document.getElementById('typing-area');
    const startButton = document.getElementById('start-test');
    const pauseButton = document.getElementById('stop-test');
    const restartButton = document.getElementById('restart-test');
    const submitButton = document.getElementById('submit-test');
    const grossSpeed = document.getElementById('live-gross-speed');
    const netSpeed = document.getElementById('live-net-speed');
    const accuracy = document.getElementById('live-accuracy');
    const mistakesDisplay = document.getElementById('live-mistakes');
    const totalWords = document.getElementById('live-total-words');
    const correctWords = document.getElementById('live-correct-words');
    const incorrectWords = document.getElementById('live-incorrect-words');
    const feedbackContainer = document.getElementById('feedback-container');
    const feedbackText = document.getElementById('feedback-text');
    const feedbackCancel = document.getElementById('feedback-cancel');

    // Utility: Normalize quotes (convert curly quotes to straight quotes)
    function normalizeQuotes(text) {
      return text
        .replace(/[\u2018\u2019]/g, "'") // Replace curly single quotes with straight
        .replace(/[\u201C\u201D]/g, '"'); // Replace curly double quotes with straight
    }

    // Utility: Sanitize input for HTML display while preserving characters for comparison
    function sanitizeInput(input) {
      const div = document.createElement('div');
      div.textContent = input;
      return div.innerHTML;
    }

    // Utility: Format time (mm:ss)
    function formatTime(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
    }

    // Debounce function
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // Check if a character is punctuation
    function isPunctuation(char) {
      const punctuation = /[.,!?;:'"()/]/;
      return punctuation.test(char);
    }

    // Intelligent character comparison
    function getCharacterHighlights(expected, typed) {
      const normalizedExpected = normalizeQuotes(expected);
      const normalizedTyped = normalizeQuotes(typed);
      const result = [];
      let typedIndex = 0;

      for (let i = 0; i < normalizedExpected.length; i++) {
        if (typedIndex < normalizedTyped.length) {
          if (normalizedExpected[i] === normalizedTyped[typedIndex]) {
            result.push({ char: normalizedExpected[i], status: 'correct' });
            typedIndex++;
          } else {
            if (i + 1 < normalizedExpected.length && typedIndex < normalizedTyped.length && normalizedExpected[i + 1] === normalizedTyped[typedIndex]) {
              result.push({ char: normalizedExpected[i], status: 'wrong' });
            } else {
              result.push({ char: normalizedExpected[i], status: 'wrong' });
              typedIndex++;
            }
          }
        } else {
          result.push({ char: normalizedExpected[i], status: 'wrong' });
        }
      }

      while (typedIndex < normalizedTyped.length) {
        result.push({ char: normalizedTyped[typedIndex], status: 'wrong' });
        typedIndex++;
      }

      return result;
    }

    // Fetch passages from API
    async function fetchPassages() {
      try {
        const response = await fetch(`${BASE_URL}/api/passages/test/Typing%20Test`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        if (!response.ok) {
          throw new Error(`Failed to fetch passages: ${response.status}`);
        }
        const data = await response.json();
        passages = Array.isArray(data) ? data : [];
        console.log('Fetched passages:', passages.length);
      } catch (error) {
        console.error('Error fetching passages:', error.message);
        passages = [];
      }
    }

    // Populate passage selector
    async function populatePassageSelector() {
      try {
        await fetchPassages();
        
        // Clear existing options
        passageSelector.innerHTML = '';
        
        // Add default option
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = 'Select Passage';
        passageSelector.appendChild(defaultOption);

        if (passages.length === 0) {
          const noPassagesOption = document.createElement('option');
          noPassagesOption.value = '';
          noPassagesOption.disabled = true;
          noPassagesOption.textContent = 'No passages available';
          passageSelector.appendChild(noPassagesOption);
          
          if (sampleText) {
            sampleText.textContent = 'No passages available for Typing Test. Please contact the admin.';
          }
          return;
        }

        // Add passage options
        passages.forEach((passage, index) => {
          if (passage && passage.title && passage.content) {
            const option = document.createElement('option');
            option.value = index.toString();
            option.textContent = passage.title;
            passageSelector.appendChild(option);
          }
        });

        // Select first passage by default if available
        if (passages.length > 0) {
          passageSelector.value = '0';
          displayPassage();
        }
      } catch (error) {
        console.error('Error populating passage selector:', error);
        if (sampleText) {
          sampleText.textContent = 'Error loading passages. Please try again later.';
        }
      }
    }

    // Calculate approximate words per line
    function calculateWordsPerLine() {
      if (!passageWords || !passageWords.length || !sampleTextContainer) {
        wordsPerLine = 1;
        return;
      }

      try {
        const containerWidth = sampleTextContainer.clientWidth;
        if (!containerWidth) {
          wordsPerLine = 1;
          return;
        }

        const tempSpan = document.createElement('span');
        tempSpan.style.fontSize = '18px';
        tempSpan.style.fontFamily = "'Times New Roman', Times, serif";
        tempSpan.style.visibility = 'hidden';
        tempSpan.style.position = 'absolute';
        tempSpan.style.whiteSpace = 'nowrap';
        document.body.appendChild(tempSpan);

        let currentLineWidth = 0;
        let wordCount = 0;
        let totalWords = 0;
        const lineHeight = 28;

        passageWords.forEach(word => {
          if (!word) return;
          tempSpan.textContent = word + ' ';
          const wordWidth = tempSpan.offsetWidth;
          
          if (currentLineWidth + wordWidth > containerWidth - 20) {
            totalWords += wordCount;
            wordCount = 1;
            currentLineWidth = wordWidth;
          } else {
            wordCount++;
            currentLineWidth += wordWidth;
          }
        });
        totalWords += wordCount;

        document.body.removeChild(tempSpan);
        const calculatedWordsPerLine = Math.floor(totalWords / Math.ceil(currentLineWidth / (containerWidth - 20)));
        wordsPerLine = Math.max(1, calculatedWordsPerLine);
      } catch (error) {
        console.error('Error calculating words per line:', error);
        wordsPerLine = 1;
      }
    }

    // Display selected passage
    function displayPassage() {
      try {
        if (!sampleText || !passageSelector) {
          console.error('Required elements not found');
          return;
        }

        // Reset state
        passageWords = [];
        wordElements = [];
        sampleText.innerHTML = '';

        const selectedPassageIndex = parseInt(passageSelector.value);
        if (isNaN(selectedPassageIndex)) {
          sampleText.textContent = 'Please select a passage';
          return;
        }

        if (!passages || !Array.isArray(passages) || selectedPassageIndex >= passages.length) {
          sampleText.textContent = 'No valid passages available';
          return;
        }

        const passage = passages[selectedPassageIndex];
        if (!passage || !passage.content || typeof passage.content !== 'string') {
          sampleText.textContent = 'Invalid passage selected';
          return;
        }

        // Split content into words and create elements
        passageWords = passage.content.trim().split(/\s+/).filter(word => word.length > 0);
        
        if (passageWords.length === 0) {
          sampleText.textContent = 'Selected passage is empty';
          return;
        }

        passageWords.forEach((word, index) => {
          const wordSpan = document.createElement('span');
          wordSpan.className = 'word';
          wordSpan.innerHTML = word.split('').map(char => `<span>${sanitizeInput(char)}</span>`).join('');
          if (index === currentWordIndex) {
            wordSpan.classList.add('current-word');
          }
          sampleText.appendChild(wordSpan);
          sampleText.appendChild(document.createTextNode(' '));
          wordElements.push(wordSpan);
        });

        // Only calculate words per line after we have valid content
        if (sampleTextContainer && sampleTextContainer.clientWidth) {
          calculateWordsPerLine();
        } else {
          wordsPerLine = 1;
        }
      } catch (error) {
        console.error('Error displaying passage:', error);
        passageWords = [];
        wordElements = [];
        if (sampleText) {
          sampleText.textContent = 'Error displaying passage. Please try again.';
        }
      }
    }

    // Update word highlight
    function updateWordHighlight() {
      wordElements.forEach((word, index) => {
        word.classList.remove('current-word');
        if (index === currentWordIndex) {
          word.classList.add('current-word');
        }
      });

      const lineNumber = Math.floor(currentWordIndex / wordsPerLine);
      if (lineNumber > currentLine) {
        currentLine = lineNumber;
        const lineHeight = 28;
        const containerHeight = sampleTextContainer.clientHeight;
        const contentHeight = sampleText.offsetHeight;
        const maxScroll = contentHeight - containerHeight;

        if (sampleTextContainer.scrollTop < maxScroll) {
          sampleTextContainer.scrollTop += lineHeight;
        }
      }
    }

    // Update letter highlights
    function updateLetterHighlight() {
      const typedText = typingArea.value;
      const typedWordsCurrent = typedText.trim().split(/\s+/);

      wordElements.forEach((word, wordIndex) => {
        const chars = word.querySelectorAll('span');
        chars.forEach(char => {
          char.classList.remove('correct-char', 'incorrect-char');
        });
      });

      for (let wordIndex = 0; wordIndex <= currentWordIndex; wordIndex++) {
        const wordElement = wordElements[wordIndex];
        if (!wordElement) continue;

        const chars = wordElement.querySelectorAll('span');
        const typedWord = wordIndex < typedWordsCurrent.length ? typedWordsCurrent[wordIndex] : '';
        const expectedWord = passageWords[wordIndex] || '';

        const highlights = getCharacterHighlights(expectedWord, typedWord);

        chars.forEach((char, charIndex) => {
          if (charIndex < highlights.length) {
            const highlight = highlights[charIndex];
            if (highlight.status === 'correct') {
              char.classList.add('correct-char');
            } else {
              char.classList.add('incorrect-char');
            }
          }
        });
      }
    }

    // Calculate test results
    function calculateResults() {
      const elapsedTime = (Date.now() - startTime) / 1000 / 60; // in minutes
      const typedText = typingArea.value;
      const words = typedText.trim().split(/\s+/);
      
      // Calculate total words typed
      const totalWordsTyped = words.length;
      
      // Calculate correct and incorrect words
      correctWordsCount = 0;
      incorrectWordsCount = 0;
      mistakes = 0;
      
      words.forEach((word, index) => {
        if (index < passageWords.length) {
          if (word === passageWords[index]) {
            correctWordsCount++;
          } else {
            incorrectWordsCount++;
            // Count character mistakes
            const expectedWord = passageWords[index];
            for (let i = 0; i < Math.max(word.length, expectedWord.length); i++) {
              if (word[i] !== expectedWord[i]) {
                mistakes++;
              }
            }
          }
        }
      });

      // Calculate speeds
      const grossWPM = Math.round((totalWordsTyped / elapsedTime) || 0);
      const netWPM = Math.round((correctWordsCount / elapsedTime) || 0);
      
      // Calculate accuracy
      const accuracyPercent = Math.round((correctWordsCount / totalWordsTyped * 100) || 0);

      // Update display
      grossSpeed.textContent = grossWPM.toString();
      netSpeed.textContent = netWPM.toString();
      accuracy.textContent = accuracyPercent.toString();
      mistakesDisplay.textContent = mistakes.toString();
      totalWords.textContent = totalWordsTyped.toString();
      correctWords.textContent = correctWordsCount.toString();
      incorrectWords.textContent = incorrectWordsCount.toString();

      return {
        grossWPM,
        netWPM,
        accuracyPercent,
        mistakes,
        totalWordsTyped,
        correctWordsCount,
        incorrectWordsCount
      };
    }

    // Generate feedback based on results
    function generateFeedback() {
      const grossWPM = parseInt(grossSpeed.textContent) || 0;
      const netWPM = parseInt(netSpeed.textContent) || 0;
      const accuracyPercent = parseInt(accuracy.textContent) || 0;

      let feedback = '';

      // Prioritize accuracy feedback
      if (accuracyPercent < 70) {
        feedback += 'Pehle accuracy par focus karo, phir speed apne aap badhegi.';
      } else if (accuracyPercent < 90) {
        feedback += 'Achhi accuracy hai, thodi aur improve karo!';
      } else {
        feedback += 'Accuracy toh shandaar hai! Ab speed par dhyan do.';
      }

      // Speed feedback if accuracy is decent
      if (accuracyPercent >= 70) {
        if (grossWPM === 0) {
          feedback += ' Typing start karo—practice se hi progress hogi!';
        } else if (grossWPM <= 19) {
          feedback += ' Shuruaat ho chuki hai, ab roz thoda practice karo!';
        } else if (grossWPM <= 29) {
          feedback += ' Achhi progress hai, lekin 35 WPM tak pahunchne ke liye lagataar typing karo!';
        } else if (grossWPM <= 34) {
          feedback += ' Bas thoda aur push karo, 35 WPM bilkul paas hai!';
        } else if (grossWPM <= 44) {
          feedback += ' Great job! Aapki typing speed government standards ke kareeb hai!';
        } else if (grossWPM <= 59) {
          feedback += ' Bahut badhiya! Aap pro level ke kareeb ho!';
        } else {
          feedback += ' Excellent speed! Aap typing master banne wale ho!';
        }

        if (netWPM < grossWPM * 0.8) {
          feedback += ' Lekin thoda consistency laao, net speed aur badh sakti hai!';
        }
      }

      // Append accuracy threshold warning if below 80%
      if (accuracyPercent < 80) {
        feedback += '*Accuracy below 80%! You need to improve to qualify for SSC CGL,RRB-NTPC*.';
      }

      feedbackText.innerHTML = `<span>${sanitizeInput(feedback)}</span>`;
      feedbackContainer.classList.add('show');
    }

    // Submit test (manual or auto)
    function submitTest() {
      // Stop the timer and update state
      clearInterval(timerInterval);
      isRunning = false;
      
      // Update UI elements
      typingArea.disabled = true;
      startButton.disabled = false;
      pauseButton.disabled = true;
      restartButton.disabled = false;
      submitButton.disabled = true;
      pauseButton.textContent = 'Pause';
      
      // Calculate and show results
      calculateResults();
      generateFeedback();
      
      // Reset counters but preserve feedback
      currentWordIndex = 0;
      currentLine = 0;
      typedWords = [];
      totalChars = 0;
      correctChars = 0;
      mistakes = 0;
      correctWordsCount = 0;
      incorrectWordsCount = 0;
      
      // Reset scroll position
      sampleTextContainer.scrollTop = 0;
      
      // Clear typing area
      typingArea.value = '';
      
      // Only display passage if it's not already displayed correctly
      const currentPassage = passages[parseInt(passageSelector.value)];
      if (!currentPassage || !sampleText.textContent.includes(currentPassage.content)) {
        displayPassage();
      }
    }

    // Start test
    function startTimer() {
      if (!isRunning) {
        if (passages.length === 0 || !passages.some(p => p.title && p.content)) {
          alert('No passages available for Typing Test. Please contact the admin.');
          return;
        }
        isRunning = true;
        startTime = Date.now();
        typingArea.disabled = false;
        typingArea.focus();
        startButton.disabled = true;
        pauseButton.disabled = false;
        restartButton.disabled = false;
        submitButton.disabled = false;
        timeLeft = parseInt(timerDurationSelector.value) || 900;
        timerDisplay.textContent = formatTime(timeLeft);
        timerInterval = setInterval(() => {
          timeLeft--;
          timerDisplay.textContent = formatTime(timeLeft);
          timerDisplay.classList.toggle('low-time', timeLeft <= 30);
          if (timeLeft <= 0) {
            submitTest();
          }
        }, 1000);
      }
    }

    // Pause/resume test
    function pauseTimer() {
      if (isRunning) {
        clearInterval(timerInterval);
        isRunning = false;
        typingArea.disabled = true;
        pauseButton.textContent = 'Resume';
      } else {
        startTimer();
        pauseButton.textContent = 'Pause';
      }
    }

    // Restart test
    function restartTest() {
      // Clear timer and reset state
      clearInterval(timerInterval);
      isRunning = false;
      startTime = null;
      
      // Reset typing area
      typingArea.disabled = true;
      typingArea.value = '';
      
      // Reset word tracking
      currentWordIndex = 0;
      currentLine = 0;
      typedWords = [];
      
      // Reset metrics
      totalChars = 0;
      correctChars = 0;
      mistakes = 0;
      correctWordsCount = 0;
      incorrectWordsCount = 0;
      
      // Reset timer
      timeLeft = parseInt(timerDurationSelector.value) || 900;
      timerDisplay.textContent = formatTime(timeLeft);
      timerDisplay.classList.remove('low-time');
      
      // Reset buttons
      startButton.disabled = false;
      pauseButton.disabled = true;
      restartButton.disabled = true;
      submitButton.disabled = true;
      pauseButton.textContent = 'Pause';
      
      // Reset display metrics
      grossSpeed.textContent = '0';
      netSpeed.textContent = '0';
      accuracy.textContent = '0';
      mistakesDisplay.textContent = '0';
      totalWords.textContent = '0';
      correctWords.textContent = '0';
      incorrectWords.textContent = '0';
      
      // Reset feedback
      feedbackContainer.classList.remove('show');
      feedbackText.innerHTML = '';
      
      // Reset scroll position and display passage
      sampleTextContainer.scrollTop = 0;
      
      // Only display passage if it's not already displayed correctly
      const currentPassage = passages[parseInt(passageSelector.value)];
      if (!currentPassage || !sampleText.textContent.includes(currentPassage.content)) {
        displayPassage();
      }
    }

    // Event listeners
    passageSelector.addEventListener('change', () => {
      currentWordIndex = 0;
      currentLine = 0;
      typedWords = [];
      totalChars = 0;
      correctChars = 0;
      mistakes = 0;
      correctWordsCount = 0;
      incorrectWordsCount = 0;
      typingArea.value = '';
      sampleTextContainer.scrollTop = 0;
      displayPassage(); // This will reset and display the new passage
      if (!isRunning) {
        // Don't call restartTest() as it would trigger displayPassage() again
        timeLeft = parseInt(timerDurationSelector.value) || 900;
        timerDisplay.textContent = formatTime(timeLeft);
        timerDisplay.classList.remove('low-time');
        startButton.disabled = false;
        pauseButton.disabled = true;
        restartButton.disabled = true;
        submitButton.disabled = true;
        pauseButton.textContent = 'Pause';
        grossSpeed.textContent = '0';
        netSpeed.textContent = '0';
        accuracy.textContent = '0';
        mistakesDisplay.textContent = '0';
        totalWords.textContent = '0';
        correctWords.textContent = '0';
        incorrectWords.textContent = '0';
        feedbackContainer.classList.remove('show');
        feedbackText.innerHTML = '';
      }
    });

    timerDurationSelector.addEventListener('change', () => {
      timeLeft = parseInt(timerDurationSelector.value) || 900;
      timerDisplay.textContent = formatTime(timeLeft);
      if (!isRunning) {
        restartTest();
      }
    });

    startButton.addEventListener('click', startTimer);

    pauseButton.addEventListener('click', pauseTimer);

    restartButton.addEventListener('click', restartTest);

    submitButton.addEventListener('click', submitTest);

    sampleTextContainer.addEventListener('click', () => {
      if (!isRunning) {
        startTimer();
      }
    });

    typingArea.addEventListener('click', () => {
      if (!isRunning && !typingArea.disabled) {
        startTimer();
      }
    });

    const handleInput = debounce(() => {
      if (!isRunning) return;

      const typedText = normalizeQuotes(typingArea.value);
      const words = typedText.trim().split(/\s+/);
      const currentWord = words[currentWordIndex] || '';
      
      // Update typed words array
      typedWords = words.slice(0, currentWordIndex);
      
      // Update character counts
      totalChars = typedText.length;
      correctChars = 0;
      const expectedText = normalizeQuotes(passageWords.slice(0, words.length).join(' '));

      for (let i = 0; i < typedText.length; i++) {
        if (i < expectedText.length && typedText[i] === expectedText[i]) {
          correctChars++;
        }
      }

      updateLetterHighlight();
      calculateResults();
    }, 50);

    typingArea.addEventListener('input', handleInput);

    typingArea.addEventListener('keydown', (e) => {
      if (!isRunning) return;

      if (e.key === ' ') {
        const typedText = typingArea.value;
        const lastChar = typedText[typedText.length - 1];
        
        // Don't allow multiple spaces
        if (lastChar === ' ') {
        e.preventDefault();
          return;
        }

        const currentWord = typedText.trim().split(/\s+/).pop() || '';
        if (!currentWord) {
          e.preventDefault();
          return;
        }

        // Allow natural space behavior
        if (currentWordIndex < passageWords.length) {
          const expectedWord = passageWords[currentWordIndex];
          if (currentWord === expectedWord) {
            correctWordsCount++;
          } else {
            incorrectWordsCount++;
          }
        currentWordIndex++;
        updateWordHighlight();
        updateLetterHighlight();
        calculateResults();

        if (currentWordIndex >= passageWords.length) {
          submitTest();
          }
        }
      } else if (e.key === 'Backspace') {
        const typedText = typingArea.value;
        const cursorPosition = typingArea.selectionStart;
        
        // If cursor is at start of a word after a space
        if (cursorPosition > 0 && typedText[cursorPosition - 1] === ' ' && currentWordIndex > 0) {
          currentWordIndex--;
          if (typedWords.length > 0) {
            const lastWord = typedWords[typedWords.length - 1];
            if (lastWord === passageWords[currentWordIndex]) {
              correctWordsCount--;
            } else {
              incorrectWordsCount--;
            }
            typedWords.pop();
          }
          updateWordHighlight();
          updateLetterHighlight();
          calculateResults();
        }
      }
    });

    // Disable arrow keys for passage scrolling
    sampleTextContainer.addEventListener('keydown', (e) => {
      if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
        e.preventDefault();
      }
    });

    feedbackCancel.addEventListener('click', () => {
      feedbackContainer.classList.remove('show');
      feedbackText.innerHTML = '';
    });

    typingArea.addEventListener('paste', (e) => {
      e.preventDefault();
      alert('Pasting text is disabled.');
    });

    typingArea.addEventListener('cut', (e) => e.preventDefault());
    typingArea.addEventListener('copy', (e) => e.preventDefault());

    sampleText.addEventListener('copy', (e) => {
      e.preventDefault();
      alert('Copying passage text is disabled.');
    });

    sampleText.addEventListener('contextmenu', (e) => {
      e.preventDefault();
    });

    // Initialize the application
    document.addEventListener('DOMContentLoaded', () => {
      // Set initial timer display
      timerDisplay.textContent = formatTime(timeLeft);
      
      // Load passages and populate selector
      // displayPassage will be called by populatePassageSelector only when needed
      populatePassageSelector();
      
      // Align the result section
      alignResultSection();
    });

    window.addEventListener('resize', alignResultSection);
  </script>
</body>
</html>